<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Archetype Dev Tool</title>
    <style>
        body { font-family: monospace; margin: 0; display: flex; height: 100vh; background: #f4f4f4; color: #333; }
        
        /* SIDEBAR (Liste) */
        aside { width: 350px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
        .toolbar { padding: 10px; border-bottom: 1px solid #ccc; background: #e0e0e0; display: flex; gap: 5px; }
        ul { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        li { padding: 8px 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        li:hover { background: #f0f0f0; }
        li.active { background: #333; color: #fff; }

        /* MAIN (DÃ©tails) */
        main { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .actions { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #ccc; }
        pre { background: #222; color: #0f0; padding: 15px; flex: 1; overflow: auto; margin: 0; border: 1px solid #000; }
        
        button { cursor: pointer; padding: 4px 8px; border: 1px solid #999; background: #eee; font-family: monospace; }
        button:hover { background: #ddd; }
        .hidden { display: none; }
    </style>
</head>
<body>

<aside>
    <div class="toolbar">
        <button onclick="loadList()">Refresh</button>
        <button onclick="createLog()">+ Log</button>
        <button onclick="purge()" style="color:red">Purge DB</button>
    </div>
    <ul id="list"></ul>
</aside>

<main id="main" class="hidden">
    <h2 id="filename" style="margin-top:0"></h2>
    
    <div class="actions">
        <button onclick="compute()">Compute Stats</button>
        <button onclick="download()">Download File</button>
        <button onclick="remove()" style="color:red">Delete</button>
    </div>

    <strong>Database Entry (JSON):</strong>
    <pre id="jsonOutput">Select a file...</pre>
</main>

<script>
    let currentLog = null;

    // --- API CALL ---
    async function api(endpoint, method = 'GET', body = null) {
        let opts = { method, headers: { 'Content-Type': 'application/json' } };
        if (body) opts.body = JSON.stringify(body);
        try {
            let res = await fetch('/api/logs/' + endpoint, opts);
            return await res.json();
        } catch (e) { alert(e); }
    }

    // --- ACTIONS ---
    async function loadList() {
        let res = await api('get');
        let ul = document.getElementById('list');
        ul.innerHTML = '';
        if(!res.data) return;

        res.data.forEach(log => {
            let li = document.createElement('li');
            li.textContent = log.logfile + (log.stats ? ' [STATS]' : '');
            li.onclick = () => selectLog(log, li);
            if(currentLog && currentLog.id === log.id) li.classList.add('active');
            ul.appendChild(li);
        });
    }

    function selectLog(log, li) {
        currentLog = log;
        // Update UI List
        document.querySelectorAll('li').forEach(el => el.classList.remove('active'));
        li.classList.add('active');
        
        // Show Content
        document.getElementById('main').classList.remove('hidden');
        document.getElementById('filename').textContent = log.logfile + ` (ID: ${log.id})`;
        
        // Parse stats string to object for pretty print, otherwise print raw
        let displayData = {...log};
        if (typeof displayData.stats === 'string') {
            try { displayData.stats = JSON.parse(displayData.stats); } catch(e){}
        }
        document.getElementById('jsonOutput').textContent = JSON.stringify(displayData, null, 2);
    }

    async function createLog() {
        await api('message', 'POST', { type: 'INF', msg: 'Manual test ' + Date.now() });
        loadList();
    }

    async function compute() {
        if(!currentLog) return;
        await api('compute', 'POST', { id: currentLog.id, filename: currentLog.logfile });
        // Refresh detail
        let res = await api('get'); 
        let updated = res.data.find(l => l.id === currentLog.id);
        if(updated) selectLog(updated, document.querySelector('.active'));
    }

    function download() {
        if(!currentLog) return;
        window.open('/api/logs/download?filename=' + currentLog.logfile);
    }

    async function remove() {
        if(!currentLog || !confirm('Delete ' + currentLog.logfile + '?')) return;
        await api('remove', 'DELETE', { filename: currentLog.logfile });
        currentLog = null;
        document.getElementById('main').classList.add('hidden');
        loadList();
    }

    async function purge() {
        let res = await api('purge', 'POST');
        alert(res.data.message);
        loadList();
    }

    // Init
    loadList();
</script>

</body>
</html>